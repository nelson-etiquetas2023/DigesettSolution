@page "/contacts/update/{id:int}"
@using Digesett.Shared.Models
@using System.Text.Json
@inject HttpClient httpClient
@inject SweetAlertService swal
@inject NavigationManager navigator

<h3>Modificar Contacto</h3>
@if(Contacto is null)
{
    <p>Cargando el contacto...</p>
}
else 
{
    <div class="row">
        <div class="col-6">
            <div class="form-group mb-3">
                <label>Id :</label>
                <input type="text" class="form-control shadow fw-bold" readonly id="Id" @bind-value="@Contacto.Id" />
            </div>
            <div class="form-group mb-3">
                <label>Nomnbre del Contacto :</label>
                <input type="text" class="form-control shadow fw-bold" id="name" @bind-value="@Contacto.Name" />
            </div>
            <div class="form-group mb-3">
                <label>Cargo :</label>
                <input type="text" class="form-control shadow fw-bold" id="cargo" @bind-value="@Contacto.Cargo" />
            </div>
            <div class="form-group mb-3">
                <label>Departamento :</label>
                <input type="text" class="form-control shadow fw-bold" id="departamento" @bind-value="@Contacto.Departamento" />
            </div>
            <div class="form-group mb-3">
                <label>Correo :</label>
                <input type="email" class="form-control shadow fw-bold" id="correo" @bind-value="@Contacto.Correo" />
            </div>
            <div class="form-group mb-3">
                <InputCheckbox class="form-check-input shadow" @bind-Value="@Contacto.Active" />
                <label>Contacto Activo</label>
            </div>
            <button class="btn btn-primary shadow mt-5" @onclick="SaveContacts" >Guardar Contacto</button>
        </div>
    </div>
}


@code {
    public Contact Contacto { get; set; } = null!;   

    [Parameter]
    public int id { get; set; }


    protected override async Task OnParametersSetAsync()
    {
        Contacto = await LoadData();
    }


    private async Task<Contact> LoadData()
    {

        var url = "http://localhost:5002/api/Contacts/" + id;
        using (httpClient = new HttpClient())
        {
            var respuesta = await httpClient.GetAsync(url);
            var resString = await respuesta.Content.ReadAsStringAsync();
            var item = JsonSerializer.Deserialize<Contact>(resString, new JsonSerializerOptions()
            {
                PropertyNameCaseInsensitive = true    
            });
            return (item is not null) ? item : new Contact { Id=-1,Name="registro no encontrado..."};
        }

    }


    private async Task SaveContacts()
    {
        using (httpClient= new HttpClient())
        {
            try
            {
                var url = "http://localhost:5002/api/Contacts/" + id;
                httpClient.DefaultRequestHeaders.Clear();
                var respuesta = await httpClient.PostAsJsonAsync<Contact>(url, Contacto);
                var rptaString = await respuesta.Content.ReadAsStringAsync();
            }
            catch(HttpRequestException httpEx)
            {
                await swal.FireAsync("error", httpEx.Message, SweetAlertIcon.Error);
            }
        }
        navigator.NavigateTo("../contacts/index");
    }
}
